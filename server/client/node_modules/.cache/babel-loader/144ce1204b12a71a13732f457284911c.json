{"ast":null,"code":"'use strict';\n\nvar _toConsumableArray = require(\"/Users/tryckhov/Dropbox/Programming/Web Development/React/g12-site/node_modules/@babel/runtime/helpers/toConsumableArray\");\n\nvar _classCallCheck = require(\"/Users/tryckhov/Dropbox/Programming/Web Development/React/g12-site/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"/Users/tryckhov/Dropbox/Programming/Web Development/React/g12-site/node_modules/@babel/runtime/helpers/createClass\");\n\nvar shared = require('../shared');\n\nvar MimeNode = require('../mime-node');\n\nvar mimeFuncs = require('../mime-funcs');\n\nvar MailMessage =\n/*#__PURE__*/\nfunction () {\n  function MailMessage(mailer, data) {\n    var _this = this;\n\n    _classCallCheck(this, MailMessage);\n\n    this.mailer = mailer;\n    this.data = {};\n    this.message = null;\n    data = data || {};\n    var options = mailer.options || {};\n    var defaults = mailer._defaults || {};\n    Object.keys(data).forEach(function (key) {\n      _this.data[key] = data[key];\n    });\n    this.data.headers = this.data.headers || {}; // apply defaults\n\n    Object.keys(defaults).forEach(function (key) {\n      if (!(key in _this.data)) {\n        _this.data[key] = defaults[key];\n      } else if (key === 'headers') {\n        // headers is a special case. Allow setting individual default headers\n        Object.keys(defaults.headers).forEach(function (key) {\n          if (!(key in _this.data.headers)) {\n            _this.data.headers[key] = defaults.headers[key];\n          }\n        });\n      }\n    }); // force specific keys from transporter options\n\n    ['disableFileAccess', 'disableUrlAccess', 'normalizeHeaderKey'].forEach(function (key) {\n      if (key in options) {\n        _this.data[key] = options[key];\n      }\n    });\n  }\n\n  _createClass(MailMessage, [{\n    key: \"resolveContent\",\n    value: function resolveContent() {\n      return shared.resolveContent.apply(shared, arguments);\n    }\n  }, {\n    key: \"resolveAll\",\n    value: function resolveAll(callback) {\n      var _this2 = this;\n\n      var keys = [[this.data, 'html'], [this.data, 'text'], [this.data, 'watchHtml'], [this.data, 'icalEvent']];\n\n      if (this.data.alternatives && this.data.alternatives.length) {\n        this.data.alternatives.forEach(function (alternative, i) {\n          keys.push([_this2.data.alternatives, i]);\n        });\n      }\n\n      if (this.data.attachments && this.data.attachments.length) {\n        this.data.attachments.forEach(function (attachment, i) {\n          if (!attachment.filename) {\n            attachment.filename = (attachment.path || attachment.href || '').split('/').pop().split('?').shift() || 'attachment-' + (i + 1);\n\n            if (attachment.filename.indexOf('.') < 0) {\n              attachment.filename += '.' + mimeFuncs.detectExtension(attachment.contentType);\n            }\n          }\n\n          if (!attachment.contentType) {\n            attachment.contentType = mimeFuncs.detectMimeType(attachment.filename || attachment.path || attachment.href || 'bin');\n          }\n\n          keys.push([_this2.data.attachments, i]);\n        });\n      }\n\n      var mimeNode = new MimeNode();\n      var addressKeys = ['from', 'to', 'cc', 'bcc', 'sender', 'replyTo'];\n      addressKeys.forEach(function (address) {\n        var value;\n\n        if (_this2.message) {\n          value = [].concat(mimeNode._parseAddresses(_this2.message.getHeader(address === 'replyTo' ? 'reply-to' : address)) || []);\n        } else if (_this2.data[address]) {\n          value = [].concat(mimeNode._parseAddresses(_this2.data[address]) || []);\n        }\n\n        if (value && value.length) {\n          _this2.data[address] = value;\n        } else if (address in _this2.data) {\n          _this2.data[address] = null;\n        }\n      });\n      var singleKeys = ['from', 'sender', 'replyTo'];\n      singleKeys.forEach(function (address) {\n        if (_this2.data[address]) {\n          _this2.data[address] = _this2.data[address].shift();\n        }\n      });\n      var pos = 0;\n\n      var resolveNext = function resolveNext() {\n        if (pos >= keys.length) {\n          return callback(null, _this2.data);\n        }\n\n        var args = keys[pos++];\n\n        if (!args[0] || !args[0][args[1]]) {\n          return resolveNext();\n        }\n\n        shared.resolveContent.apply(shared, _toConsumableArray(args).concat([function (err, value) {\n          if (err) {\n            return callback(err);\n          }\n\n          var node = {\n            content: value\n          };\n\n          if (args[0][args[1]] && typeof args[0][args[1]] === 'object' && !Buffer.isBuffer(args[0][args[1]])) {\n            Object.keys(args[0][args[1]]).forEach(function (key) {\n              if (!(key in node) && !['content', 'path', 'href', 'raw'].includes(key)) {\n                node[key] = args[0][args[1]][key];\n              }\n            });\n          }\n\n          args[0][args[1]] = node;\n          resolveNext();\n        }]));\n      };\n\n      setImmediate(function () {\n        return resolveNext();\n      });\n    }\n  }, {\n    key: \"normalize\",\n    value: function normalize(callback) {\n      var _this3 = this;\n\n      var envelope = this.data.envelope || this.message.getEnvelope();\n      var messageId = this.message.messageId();\n      this.resolveAll(function (err, data) {\n        if (err) {\n          return callback(err);\n        }\n\n        data.envelope = envelope;\n        data.messageId = messageId;\n        ['html', 'text', 'watchHtml'].forEach(function (key) {\n          if (data[key] && data[key].content) {\n            if (typeof data[key].content === 'string') {\n              data[key] = data[key].content;\n            } else if (Buffer.isBuffer(data[key].content)) {\n              data[key] = data[key].content.toString();\n            }\n          }\n        });\n\n        if (data.icalEvent && Buffer.isBuffer(data.icalEvent.content)) {\n          data.icalEvent.content = data.icalEvent.content.toString('base64');\n          data.icalEvent.encoding = 'base64';\n        }\n\n        if (data.alternatives && data.alternatives.length) {\n          data.alternatives.forEach(function (alternative) {\n            if (alternative && alternative.content && Buffer.isBuffer(alternative.content)) {\n              alternative.content = alternative.content.toString('base64');\n              alternative.encoding = 'base64';\n            }\n          });\n        }\n\n        if (data.attachments && data.attachments.length) {\n          data.attachments.forEach(function (attachment) {\n            if (attachment && attachment.content && Buffer.isBuffer(attachment.content)) {\n              attachment.content = attachment.content.toString('base64');\n              attachment.encoding = 'base64';\n            }\n          });\n        }\n\n        data.normalizedHeaders = {};\n        Object.keys(data.headers || {}).forEach(function (key) {\n          var value = [].concat(data.headers[key] || []).shift();\n          value = value && value.value || value;\n\n          if (value) {\n            if (['references', 'in-reply-to', 'message-id', 'content-id'].includes(key)) {\n              value = _this3.message._encodeHeaderValue(key, value);\n            }\n\n            data.normalizedHeaders[key] = value;\n          }\n        });\n\n        if (data.list && typeof data.list === 'object') {\n          var listHeaders = _this3._getListHeaders(data.list);\n\n          listHeaders.forEach(function (entry) {\n            data.normalizedHeaders[entry.key] = entry.value.map(function (val) {\n              return val && val.value || val;\n            }).join(', ');\n          });\n        }\n\n        if (data.references) {\n          data.normalizedHeaders.references = _this3.message._encodeHeaderValue('references', data.references);\n        }\n\n        if (data.inReplyTo) {\n          data.normalizedHeaders['in-reply-to'] = _this3.message._encodeHeaderValue('in-reply-to', data.inReplyTo);\n        }\n\n        return callback(null, data);\n      });\n    }\n  }, {\n    key: \"setMailerHeader\",\n    value: function setMailerHeader() {\n      if (!this.message || !this.data.xMailer) {\n        return;\n      }\n\n      this.message.setHeader('X-Mailer', this.data.xMailer);\n    }\n  }, {\n    key: \"setPriorityHeaders\",\n    value: function setPriorityHeaders() {\n      if (!this.message || !this.data.priority) {\n        return;\n      }\n\n      switch ((this.data.priority || '').toString().toLowerCase()) {\n        case 'high':\n          this.message.setHeader('X-Priority', '1 (Highest)');\n          this.message.setHeader('X-MSMail-Priority', 'High');\n          this.message.setHeader('Importance', 'High');\n          break;\n\n        case 'low':\n          this.message.setHeader('X-Priority', '5 (Lowest)');\n          this.message.setHeader('X-MSMail-Priority', 'Low');\n          this.message.setHeader('Importance', 'Low');\n          break;\n\n        default: // do not add anything, since all messages are 'Normal' by default\n\n      }\n    }\n  }, {\n    key: \"setListHeaders\",\n    value: function setListHeaders() {\n      var _this4 = this;\n\n      if (!this.message || !this.data.list || typeof this.data.list !== 'object') {\n        return;\n      } // add optional List-* headers\n\n\n      if (this.data.list && typeof this.data.list === 'object') {\n        this._getListHeaders(this.data.list).forEach(function (listHeader) {\n          listHeader.value.forEach(function (value) {\n            _this4.message.addHeader(listHeader.key, value);\n          });\n        });\n      }\n    }\n  }, {\n    key: \"_getListHeaders\",\n    value: function _getListHeaders(listData) {\n      var _this5 = this;\n\n      // make sure an url looks like <protocol:url>\n      return Object.keys(listData).map(function (key) {\n        return {\n          key: 'list-' + key.toLowerCase().trim(),\n          value: [].concat(listData[key] || []).map(function (value) {\n            return {\n              prepared: true,\n              foldLines: true,\n              value: [].concat(value || []).map(function (value) {\n                if (typeof value === 'string') {\n                  value = {\n                    url: value\n                  };\n                }\n\n                if (value && value.url) {\n                  if (key.toLowerCase().trim() === 'id') {\n                    // List-ID: \"comment\" <domain>\n                    var _comment = value.comment || '';\n\n                    if (mimeFuncs.isPlainText(_comment)) {\n                      _comment = '\"' + _comment + '\"';\n                    } else {\n                      _comment = mimeFuncs.encodeWord(_comment);\n                    }\n\n                    return (value.comment ? _comment + ' ' : '') + _this5._formatListUrl(value.url).replace(/^<[^:]+\\/{,2}/, '');\n                  } // List-*: <http://domain> (comment)\n\n\n                  var comment = value.comment || '';\n\n                  if (!mimeFuncs.isPlainText(comment)) {\n                    comment = mimeFuncs.encodeWord(comment);\n                  }\n\n                  return _this5._formatListUrl(value.url) + (value.comment ? ' (' + comment + ')' : '');\n                }\n\n                return '';\n              }).filter(function (value) {\n                return value;\n              }).join(', ')\n            };\n          })\n        };\n      });\n    }\n  }, {\n    key: \"_formatListUrl\",\n    value: function _formatListUrl(url) {\n      url = url.replace(/[\\s<]+|[\\s>]+/g, '');\n\n      if (/^(https?|mailto|ftp):/.test(url)) {\n        return '<' + url + '>';\n      }\n\n      if (/^[^@]+@[^@]+$/.test(url)) {\n        return '<mailto:' + url + '>';\n      }\n\n      return '<http://' + url + '>';\n    }\n  }]);\n\n  return MailMessage;\n}();\n\nmodule.exports = MailMessage;","map":null,"metadata":{},"sourceType":"script"}