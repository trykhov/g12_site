{"ast":null,"code":"'use strict';\n\nvar Mailer = require('./mailer');\n\nvar shared = require('./shared');\n\nvar SMTPPool = require('./smtp-pool');\n\nvar SMTPTransport = require('./smtp-transport');\n\nvar SendmailTransport = require('./sendmail-transport');\n\nvar StreamTransport = require('./stream-transport');\n\nvar JSONTransport = require('./json-transport');\n\nvar SESTransport = require('./ses-transport');\n\nvar fetch = require('./fetch');\n\nvar packageData = require('../package.json');\n\nvar ETHEREAL_API = (process.env.ETHEREAL_API || 'https://api.nodemailer.com').replace(/\\/+$/, '');\nvar ETHEREAL_WEB = (process.env.ETHEREAL_WEB || 'https://ethereal.email').replace(/\\/+$/, '');\nvar ETHEREAL_CACHE = ['true', 'yes', 'y', '1'].includes((process.env.ETHEREAL_CACHE || 'yes').toString().trim().toLowerCase());\nvar testAccount = false;\n\nmodule.exports.createTransport = function (transporter, defaults) {\n  var urlConfig;\n  var options;\n  var mailer;\n\n  if ( // provided transporter is a configuration object, not transporter plugin\n  typeof transporter === 'object' && typeof transporter.send !== 'function' || // provided transporter looks like a connection url\n  typeof transporter === 'string' && /^(smtps?|direct):/i.test(transporter)) {\n    if (urlConfig = typeof transporter === 'string' ? transporter : transporter.url) {\n      // parse a configuration URL into configuration options\n      options = shared.parseConnectionUrl(urlConfig);\n    } else {\n      options = transporter;\n    }\n\n    if (options.pool) {\n      transporter = new SMTPPool(options);\n    } else if (options.sendmail) {\n      transporter = new SendmailTransport(options);\n    } else if (options.streamTransport) {\n      transporter = new StreamTransport(options);\n    } else if (options.jsonTransport) {\n      transporter = new JSONTransport(options);\n    } else if (options.SES) {\n      transporter = new SESTransport(options);\n    } else {\n      transporter = new SMTPTransport(options);\n    }\n  }\n\n  mailer = new Mailer(transporter, options, defaults);\n  return mailer;\n};\n\nmodule.exports.createTestAccount = function (apiUrl, callback) {\n  var promise;\n\n  if (!callback && typeof apiUrl === 'function') {\n    callback = apiUrl;\n    apiUrl = false;\n  }\n\n  if (!callback) {\n    promise = new Promise(function (resolve, reject) {\n      callback = shared.callbackPromise(resolve, reject);\n    });\n  }\n\n  if (ETHEREAL_CACHE && testAccount) {\n    setImmediate(function () {\n      return callback(null, testAccount);\n    });\n    return promise;\n  }\n\n  apiUrl = apiUrl || ETHEREAL_API;\n  var chunks = [];\n  var chunklen = 0;\n  var req = fetch(apiUrl + '/user', {\n    contentType: 'application/json',\n    method: 'POST',\n    body: Buffer.from(JSON.stringify({\n      requestor: packageData.name,\n      version: packageData.version\n    }))\n  });\n  req.on('readable', function () {\n    var chunk;\n\n    while ((chunk = req.read()) !== null) {\n      chunks.push(chunk);\n      chunklen += chunk.length;\n    }\n  });\n  req.once('error', function (err) {\n    return callback(err);\n  });\n  req.once('end', function () {\n    var res = Buffer.concat(chunks, chunklen);\n    var data;\n    var err;\n\n    try {\n      data = JSON.parse(res.toString());\n    } catch (E) {\n      err = E;\n    }\n\n    if (err) {\n      return callback(err);\n    }\n\n    if (data.status !== 'success' || data.error) {\n      return callback(new Error(data.error || 'Request failed'));\n    }\n\n    delete data.status;\n    testAccount = data;\n    callback(null, testAccount);\n  });\n  return promise;\n};\n\nmodule.exports.getTestMessageUrl = function (info) {\n  if (!info || !info.response) {\n    return false;\n  }\n\n  var infoProps = new Map();\n  info.response.replace(/\\[([^\\]]+)\\]$/, function (m, props) {\n    props.replace(/\\b([A-Z0-9]+)=([^\\s]+)/g, function (m, key, value) {\n      infoProps.set(key, value);\n    });\n  });\n\n  if (infoProps.has('STATUS') && infoProps.has('MSGID')) {\n    return (testAccount.web || ETHEREAL_WEB) + '/message/' + infoProps.get('MSGID');\n  }\n\n  return false;\n};","map":null,"metadata":{},"sourceType":"script"}