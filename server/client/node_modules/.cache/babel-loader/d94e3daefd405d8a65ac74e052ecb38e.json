{"ast":null,"code":"'use strict';\n\nvar _classCallCheck = require(\"/Users/tryckhov/Dropbox/Programming/Web Development/React/g12-site/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"/Users/tryckhov/Dropbox/Programming/Web Development/React/g12-site/node_modules/@babel/runtime/helpers/createClass\");\n\nvar _possibleConstructorReturn = require(\"/Users/tryckhov/Dropbox/Programming/Web Development/React/g12-site/node_modules/@babel/runtime/helpers/possibleConstructorReturn\");\n\nvar _getPrototypeOf = require(\"/Users/tryckhov/Dropbox/Programming/Web Development/React/g12-site/node_modules/@babel/runtime/helpers/getPrototypeOf\");\n\nvar _inherits = require(\"/Users/tryckhov/Dropbox/Programming/Web Development/React/g12-site/node_modules/@babel/runtime/helpers/inherits\");\n\nvar EventEmitter = require('events');\n\nvar packageData = require('../../package.json');\n\nvar shared = require('../shared');\n\nvar LeWindows = require('../sendmail-transport/le-windows');\n/**\n * Generates a Transport object for AWS SES\n *\n * Possible options can be the following:\n *\n *  * **sendingRate** optional Number specifying how many messages per second should be delivered to SES\n *  * **maxConnections** optional Number specifying max number of parallel connections to SES\n *\n * @constructor\n * @param {Object} optional config parameter\n */\n\n\nvar SESTransport =\n/*#__PURE__*/\nfunction (_EventEmitter) {\n  _inherits(SESTransport, _EventEmitter);\n\n  function SESTransport(options) {\n    var _this;\n\n    _classCallCheck(this, SESTransport);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(SESTransport).call(this));\n    options = options || {};\n    _this.options = options || {};\n    _this.ses = _this.options.SES;\n    _this.name = 'SESTransport';\n    _this.version = packageData.version;\n    _this.logger = shared.getLogger(_this.options, {\n      component: _this.options.component || 'ses-transport'\n    }); // parallel sending connections\n\n    _this.maxConnections = Number(_this.options.maxConnections) || Infinity;\n    _this.connections = 0; // max messages per second\n\n    _this.sendingRate = Number(_this.options.sendingRate) || Infinity;\n    _this.sendingRateTTL = null;\n    _this.rateInterval = 1000;\n    _this.rateMessages = [];\n    _this.pending = [];\n    _this.idling = true;\n    setImmediate(function () {\n      if (_this.idling) {\n        _this.emit('idle');\n      }\n    });\n    return _this;\n  }\n  /**\n   * Schedules a sending of a message\n   *\n   * @param {Object} emailMessage MailComposer object\n   * @param {Function} callback Callback function to run when the sending is completed\n   */\n\n\n  _createClass(SESTransport, [{\n    key: \"send\",\n    value: function send(mail, callback) {\n      var _this2 = this;\n\n      if (this.connections >= this.maxConnections) {\n        this.idling = false;\n        return this.pending.push({\n          mail: mail,\n          callback: callback\n        });\n      }\n\n      if (!this._checkSendingRate()) {\n        this.idling = false;\n        return this.pending.push({\n          mail: mail,\n          callback: callback\n        });\n      }\n\n      this._send(mail, function () {\n        for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n          args[_key] = arguments[_key];\n        }\n\n        setImmediate(function () {\n          return callback.apply(void 0, args);\n        });\n\n        _this2._sent();\n      });\n    }\n  }, {\n    key: \"_checkRatedQueue\",\n    value: function _checkRatedQueue() {\n      var _this3 = this;\n\n      if (this.connections >= this.maxConnections || !this._checkSendingRate()) {\n        return;\n      }\n\n      if (!this.pending.length) {\n        if (!this.idling) {\n          this.idling = true;\n          this.emit('idle');\n        }\n\n        return;\n      }\n\n      var next = this.pending.shift();\n\n      this._send(next.mail, function () {\n        for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {\n          args[_key2] = arguments[_key2];\n        }\n\n        setImmediate(function () {\n          return next.callback.apply(next, args);\n        });\n\n        _this3._sent();\n      });\n    }\n  }, {\n    key: \"_checkSendingRate\",\n    value: function _checkSendingRate() {\n      var _this4 = this;\n\n      clearTimeout(this.sendingRateTTL);\n      var now = Date.now();\n      var oldest = false; // delete older messages\n\n      for (var i = this.rateMessages.length - 1; i >= 0; i--) {\n        if (this.rateMessages[i].ts >= now - this.rateInterval && (!oldest || this.rateMessages[i].ts < oldest)) {\n          oldest = this.rateMessages[i].ts;\n        }\n\n        if (this.rateMessages[i].ts < now - this.rateInterval && !this.rateMessages[i].pending) {\n          this.rateMessages.splice(i, 1);\n        }\n      }\n\n      if (this.rateMessages.length < this.sendingRate) {\n        return true;\n      }\n\n      var delay = Math.max(oldest + 1001, now + 20);\n      this.sendingRateTTL = setTimeout(function () {\n        return _this4._checkRatedQueue();\n      }, now - delay);\n\n      try {\n        this.sendingRateTTL.unref();\n      } catch (E) {// Ignore. Happens on envs with non-node timer implementation\n      }\n\n      return false;\n    }\n  }, {\n    key: \"_sent\",\n    value: function _sent() {\n      this.connections--;\n\n      this._checkRatedQueue();\n    }\n    /**\n     * Returns true if there are free slots in the queue\n     */\n\n  }, {\n    key: \"isIdle\",\n    value: function isIdle() {\n      return this.idling;\n    }\n    /**\n     * Compiles a mailcomposer message and forwards it to SES\n     *\n     * @param {Object} emailMessage MailComposer object\n     * @param {Function} callback Callback function to run when the sending is completed\n     */\n\n  }, {\n    key: \"_send\",\n    value: function _send(mail, callback) {\n      var _this5 = this;\n\n      var statObject = {\n        ts: Date.now(),\n        pending: true\n      };\n      this.connections++;\n      this.rateMessages.push(statObject);\n      var envelope = mail.data.envelope || mail.message.getEnvelope();\n      var messageId = mail.message.messageId();\n      var recipients = [].concat(envelope.to || []);\n\n      if (recipients.length > 3) {\n        recipients.push('...and ' + recipients.splice(2).length + ' more');\n      }\n\n      this.logger.info({\n        tnx: 'send',\n        messageId: messageId\n      }, 'Sending message %s to <%s>', messageId, recipients.join(', '));\n\n      var getRawMessage = function getRawMessage(next) {\n        // do not use Message-ID and Date in DKIM signature\n        if (!mail.data._dkim) {\n          mail.data._dkim = {};\n        }\n\n        if (mail.data._dkim.skipFields && typeof mail.data._dkim.skipFields === 'string') {\n          mail.data._dkim.skipFields += ':date:message-id';\n        } else {\n          mail.data._dkim.skipFields = 'date:message-id';\n        }\n\n        var sourceStream = mail.message.createReadStream();\n        var stream = sourceStream.pipe(new LeWindows());\n        var chunks = [];\n        var chunklen = 0;\n        stream.on('readable', function () {\n          var chunk;\n\n          while ((chunk = stream.read()) !== null) {\n            chunks.push(chunk);\n            chunklen += chunk.length;\n          }\n        });\n        sourceStream.once('error', function (err) {\n          return stream.emit('error', err);\n        });\n        stream.once('error', function (err) {\n          next(err);\n        });\n        stream.once('end', function () {\n          return next(null, Buffer.concat(chunks, chunklen));\n        });\n      };\n\n      setImmediate(function () {\n        return getRawMessage(function (err, raw) {\n          if (err) {\n            _this5.logger.error({\n              err: err,\n              tnx: 'send',\n              messageId: messageId\n            }, 'Failed creating message for %s. %s', messageId, err.message);\n\n            statObject.pending = false;\n            return callback(err);\n          }\n\n          var sesMessage = {\n            RawMessage: {\n              // required\n              Data: raw // required\n\n            },\n            Source: envelope.from,\n            Destinations: envelope.to\n          };\n          Object.keys(mail.data.ses || {}).forEach(function (key) {\n            sesMessage[key] = mail.data.ses[key];\n          });\n\n          _this5.ses.sendRawEmail(sesMessage, function (err, data) {\n            if (err) {\n              _this5.logger.error({\n                err: err,\n                tnx: 'send'\n              }, 'Send error for %s: %s', messageId, err.message);\n\n              statObject.pending = false;\n              return callback(err);\n            }\n\n            var region = _this5.ses.config && _this5.ses.config.region || 'us-east-1';\n\n            if (region === 'us-east-1') {\n              region = 'email';\n            }\n\n            statObject.pending = false;\n            callback(null, {\n              envelope: {\n                from: envelope.from,\n                to: envelope.to\n              },\n              messageId: '<' + data.MessageId + (!/@/.test(data.MessageId) ? '@' + region + '.amazonses.com' : '') + '>',\n              response: data.MessageId,\n              raw: raw\n            });\n          });\n        });\n      });\n    }\n    /**\n     * Verifies SES configuration\n     *\n     * @param {Function} callback Callback function\n     */\n\n  }, {\n    key: \"verify\",\n    value: function verify(callback) {\n      var promise;\n\n      if (!callback) {\n        promise = new Promise(function (resolve, reject) {\n          callback = shared.callbackPromise(resolve, reject);\n        });\n      }\n\n      this.ses.sendRawEmail({\n        RawMessage: {\n          // required\n          Data: 'From: invalid@invalid\\r\\nTo: invalid@invalid\\r\\n Subject: Invalid\\r\\n\\r\\nInvalid'\n        },\n        Source: 'invalid@invalid',\n        Destinations: ['invalid@invalid']\n      }, function (err) {\n        if (err && err.code !== 'InvalidParameterValue') {\n          return callback(err);\n        }\n\n        return callback(null, true);\n      });\n      return promise;\n    }\n  }]);\n\n  return SESTransport;\n}(EventEmitter);\n\nmodule.exports = SESTransport;","map":null,"metadata":{},"sourceType":"script"}